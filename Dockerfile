FROM osrf/ros:iron-desktop-full

RUN sudo apt-get update -y

# Install missing libxcb-cursor0 xvfb for PyQt unit testing
# https://pytest-qt.readthedocs.io/en/latest/troubleshooting.html
RUN sudo apt-get install xvfb -y

# Install pip
RUN sudo apt-get install python3-pip -y

# Install Video for Linux
RUN sudo apt-get install v4l-utils -y

# Install lsusb
RUN sudo apt-get install usbutils -y

# Install nano
RUN sudo apt-get install nano -y

RUN sudo apt-get update -y
RUN sudo apt-get upgrade -y

WORKDIR /root/rov-24

COPY pyproject.toml .

RUN pip install --no-cache-dir . \
  && rm pyproject.toml

COPY . .

# TODO for future nerd to do this via ENTRYPOINT which be better but, I could not get ENTRYPOINT to play with VsCODE.
RUN . /root/rov-24/.vscode/rov_setup.sh
RUN echo "$export PYTHONWARNINGS=ignore:::setuptools.command.install,ignore:::setuptools.command.easy_install,ignore:::pkg_resources" >> ~/.bashrc ;

# Installs ROS and python dependencies
RUN . /root/rov-24/.vscode/install_dependencies.sh

RUN . /opt/ros/iron/setup.sh \
    && PYTHONWARNINGS=ignore:::setuptools.command.install,ignore:::setuptools.command.easy_install,ignore:::pkg_resources; export PYTHONWARNINGS\
    && colcon build --symlink-install

# Remove identity file generated by action/checkout
# Start by finding all files ending in config
# Then removes file paths without "git"
# Then removes the 'sshCommand' line from each file
RUN  find . -name "*config" | grep git | while read -r line; do sed -i '/sshCommand/d' $line; done
